# Docker Compose for CoreVPN
# Quick local deployment for testing

version: '3.8'

services:
  corevpn-server:
    build:
      context: ..
      dockerfile: Dockerfile
    image: corevpn:latest
    container_name: corevpn-server
    restart: unless-stopped

    # Required for VPN operation
    cap_add:
      - NET_ADMIN
      - NET_RAW
    devices:
      - /dev/net/tun:/dev/net/tun

    # Sysctls for IP forwarding
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1

    ports:
      - "1194:1194/udp"
      - "443:443/tcp"

    environment:
      - RUST_LOG=info
      - COREVPN_ADMIN_PASSWORD=${COREVPN_ADMIN_PASSWORD:-changeme}

    volumes:
      - ./config:/etc/corevpn:ro
      - corevpn-data:/var/lib/corevpn
      - corevpn-logs:/var/log/corevpn

    command: ["run", "--config", "/etc/corevpn/config.toml"]

    healthcheck:
      test: ["CMD", "pgrep", "corevpn-server"]
      interval: 30s
      timeout: 5s
      retries: 3

  corevpn-web:
    build:
      context: ..
      dockerfile: Dockerfile
    image: corevpn:latest
    container_name: corevpn-web
    restart: unless-stopped

    ports:
      - "8080:8080"

    environment:
      - RUST_LOG=info
      - COREVPN_ADMIN_PASSWORD=${COREVPN_ADMIN_PASSWORD:-changeme}

    volumes:
      - ./config:/etc/corevpn:ro
      - corevpn-data:/var/lib/corevpn:ro

    command: ["web", "--config", "/etc/corevpn/config.toml", "--listen", "0.0.0.0:8080"]

    depends_on:
      - corevpn-server

    healthcheck:
      test: ["CMD", "wget", "-q", "-O-", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3

volumes:
  corevpn-data:
  corevpn-logs:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
